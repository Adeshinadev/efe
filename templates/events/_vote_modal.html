{% load static %}
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
/* Vote modal styles */
.vote-modal{background:#171a1f;color:#e8eaf0}
.vote-modal .modal-body{padding:30px}
.vote-modal .form-control{background:#0f1217;border:1px solid rgba(212,175,55,.45);color:#e8eaf0}
.vote-modal select.form-control {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: #0f1217;
  color: #e8eaf0;
  border: 1px solid rgba(212,175,55,.55);
  padding: 14px;
  font-size: 1rem;
  position: relative;
  z-index: 10;
}

.vote-modal select.form-control option {
  background: #0f1217;
  color: #e8eaf0;
  padding: 12px;
  font-size: 1rem;
}

/* Ensure dropdown opens above modal elements */
.vote-modal select {
  position: relative;
  z-index: 9999 !important;
}
.vote-modal .form-control:focus{border-color:#d4af37;box-shadow:0 0 0 2px rgba(212,175,55,.15)}
.vote-modal .input-group .btn{background:#0f1217;border:1px solid rgba(255,255,255,.12);color:#e8eaf0}
.vote-modal label{font-weight:700}
.vote-modal .total-box{font-size:1.2rem;font-weight:800;text-align:right}
.vote-modal .candidate-card{border:1px solid rgba(255,255,255,.12);background:#0f1217;color:#e8eaf0;border-radius:12px;padding:12px;transition:.15s;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:210px;height:100%;gap:8px}
.vote-modal .candidate-card:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(0,0,0,.25)}
.vote-modal .candidate-card.selected{border-color:#d4af37;box-shadow:0 0 0 2px rgba(212,175,55,.25)}
.vote-modal .candidate-card .photo{width:84px;height:84px;border-radius:10px;overflow:hidden;background:#121419;margin:0 auto 8px auto;flex:0 0 auto}
.vote-modal .candidate-card .name{font-size:.9rem;line-height:1.2;text-align:center;color:#e8eaf0;font-weight:700;max-width:100%;margin-top:auto;min-height:2.4em;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}
.cand-col{display:flex}
.cand-col .candidate-card{width:100%}
.vote-modal .muted{color:#a7adb9}
.hidden{display:none!important}
.is-loading{pointer-events:none;opacity:.7}

/* Fix select dropdown clipping and visibility */
.modal-content {
  overflow: visible !important;
}

.vote-modal select.form-control {
  max-height: 55px;
}

.vote-modal select.form-control option {
  height: 50px;
  padding: 14px;
}
</style>

<div class="modal fade" id="voteModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content sigma-card vote-modal" style="border:0;">
      <div class="modal-body p-30">
        <div class="d-flex justify-content-between align-items-center mb-20">
          <h4 class="mb-0">Vote for Your Favorite</h4>
          <a href="#" class="remove" data-dismiss="modal"><i class="fal fa-times"></i></a>
        </div>

        {% if not is_active %}
          <div class="alert alert-warning mb-20" role="alert" style="background:#2d1f07;color:#f6e9c2;border:1px solid #3c2a0a">
            Voting hasn‚Äôt started yet. Please check back once the event begins.
          </div>
          <small class="text-muted d-block">Voting opens on {{ event.start_at|date:"D, M j, Y g:i A" }}.</small>
        {% endif %}

        {% if is_active %}
        <div id="votingForm">
          <!-- Category -->
          <div class="form-group">
            <label for="voteCategory"><strong>Category</strong></label>
            <select id="voteCategory" class="form-control" onchange="window.__onVoteCatChange &amp;&amp; window.__onVoteCatChange(this.value)">
              <option value="" selected disabled>Choose a category</option>
              {% for cat in categories_payload %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
<br><br>
          <!-- Candidates -->
          <div id="candidateBlock" class="mt-3 hidden">
            <label class="d-block"><strong>Candidates</strong>

             <small class="text-muted d-block" style="font-size:13px;font-weight:400;">
      Select the brand you'd like to vote for
    </small>

            </label>
            <div id="candidateGrid" class="row"></div>

            <!-- Loading Spinner -->
            <div id="candidateLoader" class="hidden text-center mt-3">
              <div class="spinner-border text-warning" role="status" style="width:2.5rem;height:2.5rem;">
                <span class="sr-only">Loading...</span>
              </div>
              <div class="muted mt-2">Loading candidates...</div>
            </div>
          <div id="candidateEmpty" class="muted hidden" style="padding:8px 2px">No candidates found for this category.</div>
        </div>

        <!-- Email (required by Paystack) -->
        <div class="form-group mt-3 hidden" id="voteEmailBlock">
          <label for="voteEmail"><strong>Email (required for payment)</strong></label>
          <input type="email" id="voteEmail" class="form-control" placeholder="you@example.com" autocomplete="email">
          <small class="text-muted d-block mt-1">We don‚Äôt store this here ‚Äî Paystack needs an email to issue your receipt.</small>
        </div>

        <hr class="my-20">

          <!-- Votes / Total -->
          <div class="row hidden" id="voteCountBlock">
            <div class="col-md-6">
              <label for="voteQty"><strong>Number of votes</strong></label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary" type="button" id="qtyMinus" aria-label="Decrease">‚àí</button>
                </div>
                <input type="number" id="voteQty" class="form-control" min="1" value="1">
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="button" id="qtyPlus" aria-label="Increase">+</button>
                </div>
              </div>
              <small class="text-muted d-block mt-1">Price per vote: {{ event.currency }} {{ event.vote_unit_price }}</small>
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <div class="w-100 text-md-right mt-3 mt-md-0">
                <div class="total-box"><strong>Total:</strong>
                  <span id="voteTotal" data-unit="{{ event.vote_unit_price }}" data-currency="{{ event.currency }}">
                    {{ event.currency }} {{ event.vote_unit_price }}
                  </span>
                </div>
                <small class="text-muted">Updates automatically as you change quantity.</small>
              </div>
            </div>
          </div>


          <hr class="my-20">

          <div class="d-flex justify-content-end hidden" id="votePayBlock">
            <button id="payNowBtn" class="btn btn-gold" disabled>
              <span class="btn-text">Pay &amp; Vote</span>
              <span class="btn-spinner hidden" aria-hidden="true">&nbsp;‚Ä¢&nbsp;Processing‚Ä¶</span>
            </button>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
</div>
</div>
</div>

<!-- Success Modal (works with or without Bootstrap JS) -->
<style>
  .success-modal .modal-content{
    background:#171a1f;color:#e8eaf0;border:0;border-radius:14px;
    text-align:center; padding:28px 24px;
  }
  .success-modal .emoji{font-size:48px;line-height:1;margin-bottom:8px}
  .success-modal .lead{font-size:1.05rem;margin:8px 0 2px 0}
  .success-modal .muted{color:#a7adb9}
</style>

<div class="modal fade success-modal" id="voteSuccessModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="max-width:520px">
    <div class="modal-content">
      <div class="emoji" aria-hidden="true">üëç</div>
      <h4 id="vsTitle" class="mb-10">Payment successful</h4>
      <p id="vsBody" class="lead">Your votes have been recorded.</p>
      <p id="vsMeta" class="muted"></p>
      <div class="mt-3">
        <button type="button" class="btn btn-gold" id="vsDoneBtn">Done</button>
      </div>
    </div>
  </div>
</div>

{% if is_active %}
<script>
  // Server ‚Üí JS data (must be valid JSON)
  window.__VOTE_DATA__ = { categories: {{ categories_json|safe }} };
</script>
<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
(function(){
  const LOG = () => {};

  function showSuccessModal({candidateName, votes, reference}){
    const m = document.getElementById('voteSuccessModal');
    const t = document.getElementById('vsTitle');
    const b = document.getElementById('vsBody');
    const meta = document.getElementById('vsMeta');
    const done = document.getElementById('vsDoneBtn');

    const safeVotes = Math.max(1, parseInt(votes || '1', 10));
    const safeName = candidateName || 'selected candidate';
    if (t) t.textContent = 'Payment successful';
    if (b) b.textContent = `Your ${safeVotes} vote${safeVotes > 1 ? 's' : ''} for ${safeName} have been recorded.`;
    if (meta) meta.textContent = `Reference: ${reference}`;

    const hasBS = !!(window.bootstrap && window.bootstrap.Modal);
    const hasjQuery = !!window.jQuery && !!jQuery.fn && !!jQuery.fn.modal;

    // Show
    if (m){
      if (hasBS){
        // Compatible with BS 5.0‚Äì5.3+
        let inst = null;
        try { inst = window.bootstrap.Modal.getInstance(m); } catch(e) {}
        if (!inst) {
          try { inst = new window.bootstrap.Modal(m); } catch(e) { inst = null; }
        }
        if (inst && typeof inst.show === 'function') {
          inst.show();
        } else {
          // Hard fallback if something unexpected happens
          m.style.display = 'block';
          m.classList.add('show');
          m.removeAttribute('aria-hidden');
          let bd = document.createElement('div');
          bd.id = 'vsBackdrop';
          bd.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1040';
          document.body.appendChild(bd);
        }
      } else if (hasjQuery){
        jQuery(m).modal('show');
      } else {
        m.style.display = 'block';
        m.classList.add('show');
        m.removeAttribute('aria-hidden');
        let bd = document.createElement('div');
        bd.id = 'vsBackdrop';
        bd.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1040';
        document.body.appendChild(bd);
      }

      // Done button
      if (done){
        done.onclick = function(){
          if (hasBS){
            let inst = null;
            try { inst = window.bootstrap.Modal.getInstance(m); } catch(e) {}
            if (!inst) {
              try { inst = new window.bootstrap.Modal(m); } catch(e) { inst = null; }
            }
            if (inst && typeof inst.hide === 'function') {
              inst.hide();
            } else {
              m.style.display = 'none';
              m.classList.remove('show');
              m.setAttribute('aria-hidden','true');
              const bd = document.getElementById('vsBackdrop');
              if (bd) bd.remove();
            }
          } else if (hasjQuery){
            jQuery(m).modal('hide');
          } else {
            m.style.display = 'none';
            m.classList.remove('show');
            m.setAttribute('aria-hidden','true');
            const bd = document.getElementById('vsBackdrop');
            if (bd) bd.remove();
          }
          window.location.reload();
        };
      }
    }
  }

  function getCsrf(){
    const el = document.querySelector('meta[name="csrf-token"]');
    return el ? el.getAttribute('content') : '';
  }
  const CSRF_TOKEN = getCsrf();
  const CHECKOUT_INIT_URL = "{% url 'vote_checkout_init' slug=event.slug %}";

  function initVoteModal(){
    LOG('init start');

    // 1) Read & normalize data
    const raw = (window.__VOTE_DATA__ || {}).categories || [];
    LOG('raw categories type:', typeof raw, 'value:', raw);

    const normCand = x => ({
      id: String(x?.id ?? x?.pk ?? x?.slug ?? '').trim(),
      name: x?.name ?? x?.title ?? '',
      photo: x?.photo ?? x?.photo_url ?? x?.image ?? ''
    });
    const normCat  = c => c ? ({
      id: String(c?.id ?? c?.pk ?? c?.slug ?? '').trim(),
      name: c?.name ?? c?.title ?? '',
      candidates: (c?.candidates ?? c?.items ?? []).map(normCand)
    }) : null;

    const data = raw.map(normCat).filter(Boolean);
    LOG('normalized categories:', data);

    // 2) Quick lookup map
    const catIndex = new Map(data.map(c => [c.id, c]));
    LOG('cat index keys:', Array.from(catIndex.keys()));

    // 3) Grab elements
    const selCategory = document.getElementById('voteCategory');
    const grid = document.getElementById('candidateGrid');
    const block = document.getElementById('candidateBlock');
    const emptyMsg = document.getElementById('candidateEmpty');
    const qty = document.getElementById('voteQty');
    const minus = document.getElementById('qtyMinus');
    const plus = document.getElementById('qtyPlus');
    const totalEl = document.getElementById('voteTotal');
    const payBtn = document.getElementById('payNowBtn');
    const emailEl = document.getElementById('voteEmail');

    const unit = parseFloat(totalEl?.getAttribute('data-unit') || '0');
    const currency = totalEl?.getAttribute('data-currency') || '';
    let selectedCandidateId = null;
    let selectedCandidateName = '';

    LOG('elements:', {selCategory, grid, block, emptyMsg, qty, minus, plus, totalEl, payBtn, unit, currency});

    // 4) Helpers
    const fmtMoney = n => {
      try { return currency + ' ' + Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
      catch(_) { return currency + ' ' + n; }
    };

    function recalc(){
      if (!qty || !totalEl) return;
      let q = Math.max(1, parseInt(qty.value || '1', 10));
      qty.value = q;
      const amount = unit * q;
      totalEl.textContent = fmtMoney(amount.toFixed(2));
      const valid = !!(selectedCandidateId && selCategory && selCategory.value && q >= 1);
      if (payBtn) payBtn.disabled = !valid;
      LOG('recalc -> qty:', q, 'unit:', unit, 'amount:', amount, 'valid:', valid, 'pay disabled:', !!payBtn && payBtn.disabled);
    }

    function renderCandidates(list){
      LOG('renderCandidates called with', Array.isArray(list) ? list.length : 'null', 'items');

      if (!grid || !block){
        LOG('renderCandidates: missing grid/block');
        return;
      }

      grid.innerHTML = '';
      selectedCandidateId = null;
      selectedCandidateName = '';

      // Always show the block when a category is selected
      block.classList.remove('hidden');

      if (!list || !list.length){
        emptyMsg && emptyMsg.classList.remove('hidden');
        // Hide email, count, and pay blocks when no candidates
        document.getElementById("voteEmailBlock").classList.add("hidden");
        document.getElementById("voteCountBlock").classList.add("hidden");
        document.getElementById("votePayBlock").classList.add("hidden");
        LOG('renderCandidates: no candidates -> showing empty state');
        recalc();
        return;
      }

      emptyMsg && emptyMsg.classList.add('hidden');
      // Show email, count, and pay blocks when candidates are present
      document.getElementById("voteEmailBlock").classList.remove("hidden");
      document.getElementById("voteCountBlock").classList.remove("hidden");
      document.getElementById("votePayBlock").classList.remove("hidden");
      LOG('renderCandidates: rendering', list.length, 'candidates');

      list.forEach(function(c){
        const col = document.createElement('div');
        col.className = 'col-6 col-sm-4 mb-3 cand-col';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'candidate-card btn btn-block';
        btn.innerHTML = `
          <div class="photo">
            ${c.photo ? `<img src="${c.photo}" alt="${c.name}" style="width:100%;height:100%;object-fit:cover">` : ''}
          </div>
          <div class="name">${c.name}</div>
        `;

        btn.addEventListener('click', function(){
          grid.querySelectorAll('.candidate-card').forEach(function(b){ b.classList.remove('selected'); });
          btn.classList.add('selected');
          selectedCandidateId = c.id;
          selectedCandidateName = c.name;
          LOG('renderCandidates: selected candidate', selectedCandidateId);
          recalc();
        });

        col.appendChild(btn);
        grid.appendChild(col);
      });

      recalc();
    }

    function onCatChange(){
      LOG('onCatChange fired');
      if (!selCategory) return;

      const id = String(selCategory.value || '').trim();
      LOG('category change -> selected value:', id);

      // ‚úÖ Show loader and hide grid while loading
      document.getElementById("candidateLoader").classList.remove("hidden");
      block.classList.remove("hidden");
      grid.innerHTML = "";
      emptyMsg && emptyMsg.classList.add("hidden");

      // Optional small delay to show loader
      setTimeout(() => {
        const startTime = Date.now();
        let cat = catIndex.get(id);
        if (!cat) {
          cat = data.find(x => x.id.toLowerCase() === id.toLowerCase());
        }

        // Wait minimum 3 seconds BEFORE showing candidates
        setTimeout(() => {
          if (!cat) {
            LOG('No category matched');
            renderCandidates([]);
          } else {
            renderCandidates(cat.candidates);
          }

          // Now hide spinner AFTER candidates have been rendered
          document.getElementById("candidateLoader").classList.add("hidden");

        }, 3000);  // ‚è≥ enforce minimum 3 seconds spinner before showing candidates

      }, 0);  // (leave unchanged if already 0, just ensure inner timeout is 3000ms)
    }
    // Global fallback so inline onchange can call into this module
    window.__onVoteCatChange = function(val){
      LOG('inline onchange fired with value:', val);
      if (selCategory) selCategory.value = String(val || '').trim();
      onCatChange();
    };

    // 5) Attach listeners
    if (selCategory) {
      selCategory.removeEventListener('change', onCatChange); // avoid duplicates on re-open
      selCategory.addEventListener('change', onCatChange);
      LOG('change listener attached on #voteCategory');

      // Delegated listener as a final safety net
      document.addEventListener('change', function(e){
        if (e && e.target && e.target.id === 'voteCategory'){
          LOG('delegated change fired with value:', e.target.value);
          onCatChange();
        }
      });
    }

    minus && minus.addEventListener('click', () => { qty.value = Math.max(1, (parseInt(qty.value||'1',10)-1)); recalc(); });
    plus  && plus.addEventListener('click',  () => { qty.value = Math.max(1, (parseInt(qty.value||'1',10)+1)); recalc(); });
    qty   && qty.addEventListener('input', recalc);



    if (payBtn){
      payBtn.disabled = true;
      payBtn.addEventListener('click', async function(){
        if (payBtn.disabled) return;

        // Require a valid email for Paystack
        const emailVal = emailEl ? String(emailEl.value || '').trim() : '';
        const emailOk = /^\S+@\S+\.\S+$/.test(emailVal);
        if (!emailOk){
          alert('Please enter a valid email to continue to payment.');
          if (emailEl) emailEl.focus();
          return;
        }

        const votes = Math.max(1, parseInt(qty.value || '1', 10));
        const payload = {
          category_id: String(selCategory.value || '').trim(),
          candidate_id: String(selectedCandidateId || '').trim(),
          votes: votes,
          amount: (unit * votes).toFixed(2),
          currency: currency,
          gateway: 'paystack',
          email: emailVal,
        };
        LOG('create purchase payload:', payload);

        // UI loading state
        const btnText = payBtn.querySelector('.btn-text');
        const btnSpin = payBtn.querySelector('.btn-spinner');
        payBtn.classList.add('is-loading');
        btnText && (btnText.style.opacity = .6);
        btnSpin && btnSpin.classList.remove('hidden');

        try {
          const res = await fetch(CHECKOUT_INIT_URL, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(payload)
          });

          if (!res.ok){
            const t = await res.text();
            alert('Could not start checkout. Please try again.');
            return;
          }

          const data = await res.json();
          LOG('VotePurchase created:', data);
          // Expected: { reference, amount_kobo, public_key, email, currency }
          const ref = data.reference;
          const key = data.public_key;
          const amountKobo = data.amount_kobo;
          // Email is now optional; rely on Paystack's checkout page to collect payer email

          // Helper function for Paystack verification and finalization
          async function verifyAndFinalize(reference){
            try{
              const vres = await fetch('/paystack/verify/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ reference })
              });
              const vdata = await vres.json().catch(()=>({}));
              LOG('Verify result:', vres.status, vdata);
              if (vres.ok && (vdata.status === 'success' || vdata.ok)){
                showSuccessModal({
                  candidateName: selectedCandidateName || 'selected candidate',
                  votes: Math.max(1, parseInt(qty.value || '1', 10)),
                  reference
                });
              } else {
                alert('We received your payment but could not verify automatically. Please contact support with ref: ' + reference);
              }
            } catch(err){
              alert('Payment completed, verification pending. Ref: ' + reference);
            }
          }

          if (!window.PaystackPop || !key){
            alert('Payment library missing. Please refresh and try again.');
            return;
          }

          // Determine an email for Paystack (required by their SDK). Use provided email if present, else backend email, else fallback.
          const emailForPs = emailVal || (data.email && String(data.email).includes('@') ? data.email : (`guest+${ref}@noemail.local`));

          const psConfig = {
            key: key,
            email: emailForPs,
            amount: amountKobo,
            currency: data.currency || currency,
            ref: ref,
            callback: function(response){
              LOG('Paystack callback:', response);
              verifyAndFinalize(response.reference);
            },
            onClose: function(){
              LOG('Paystack modal closed');
              payBtn.classList.remove('is-loading');
              btnText && (btnText.style.opacity = 1);
              btnSpin && btnSpin.classList.add('hidden');
            }
          };

          const handler = PaystackPop.setup(psConfig);
          handler.openIframe();
        } catch (err){
          alert('Network error. Please try again.');
        } finally {
          // Note: on successful payment the page reloads in callback; otherwise restore button here
          payBtn.classList.remove('is-loading');
          btnText && (btnText.style.opacity = 1);
          btnSpin && btnSpin.classList.add('hidden');
        }
      });
    }

    // 6) Preselected support
    if (selCategory && selCategory.value){
      LOG('preselected category value detected:', selCategory.value);
      onCatChange();
    } else {
      LOG('no preselected category');
    }

    recalc();
    LOG('init complete');
  }

  // Initialize on DOM ready (covers first page load)
  document.addEventListener('DOMContentLoaded', initVoteModal);

  // Re-init every time the modal is shown (covers re-open after navigating)
  const voteModalEl = document.getElementById('voteModal');
  if (voteModalEl) {
    // Bootstrap 5 event
    voteModalEl.addEventListener('shown.bs.modal', initVoteModal);
    // Bootstrap 4 fallback via jQuery (if jQuery is present)
    if (window.jQuery) {
      jQuery(voteModalEl).on('shown.bs.modal', initVoteModal);
    }
  }

  // Safety: also init after clicking any trigger (covers cases where partial loads late)
  document.querySelectorAll('[data-target="#voteModal"], [data-bs-target="#voteModal"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      setTimeout(initVoteModal, 0);
    });
  });
})();
</script>
{% endif %}