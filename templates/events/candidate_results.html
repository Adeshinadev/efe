{% extends "base.html" %}
{% load static %}

{% block title %}Your Results â€“ {{ event.title }}{% endblock %}

{% block content %}
<style>
  .results-page{
    padding-top: 120px;
    padding-bottom: clamp(60px, 8vw, 120px);
    min-height: 100vh;
  }
  .sticky-spacer{ height: 220px; }

  @media (max-width: 576px){
    .sticky-spacer{ height: 240px; }

    .actions-dropdown{ position: static !important; }
    .actions-dropdown > button.actions-btn{ display:none !important; }

    .fab-actions{ display:flex !important; }
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  }

  .results-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:20px}
  .results-header h3{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(20px,4.8vw,28px);}
  .actions-dropdown button{font-size:0.95rem;padding:8px 18px}

  /* Desktop dropdown behavior */
  #actionsMenu{
    position:absolute;
    right:0;
    top:calc(100% + 8px);
    min-width:220px;
    background:#0f1217;
    border:1px solid rgba(255,255,255,.12);
    border-radius:10px;
    box-shadow:0 12px 28px rgba(0,0,0,.35);
    padding:6px;
    display:none;
    z-index:3000;
  }
  #actionsMenu.open{ display:block; }

  @media (max-width: 576px){
    .results-header{flex-direction:column;align-items:stretch;text-align:center}
    .actions-dropdown{width:100%;}
    .actions-dropdown > button{width:100%;padding:10px 14px;border-radius:10px}

    /* Mobile: float the menu above the FAB in bottom-right corner */
    #actionsMenu{
      position:fixed !important;
      right:16px !important;
      left:auto !important;
      top:auto !important;
      bottom:calc(env(safe-area-inset-bottom,0px) + 80px) !important;
      width:min(90vw, 280px) !important;
      z-index:4000 !important;
      display:none;            /* hidden by default */
    }
    #actionsMenu.open{ display:block; }   /* shown when toggled */

    #actionsMenu button{width:100%;text-align:left}
  }

  /* Floating action button on mobile */
  .fab-actions{display:none;}
  @media (max-width:576px){
    .fab-actions{
      display:flex;
      position:fixed;
      right:16px;
      bottom:calc(env(safe-area-inset-bottom,0px) + 16px);
      padding:10px 18px;
      border-radius:8px;
      background:#0d6efd;
      color:#fff;
      border:0;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 24px rgba(13,110,253,.35);
      z-index:3500;
      cursor:pointer;
      font-weight:800;
      font-size:1rem;
    }
    .fab-actions span{font-size:1rem; line-height:1;}
    .actions-dropdown button.actions-btn, .kebab-btn{display:none !important;}
  }
</style>
<div id="stickySpacer" class="sticky-spacer" aria-hidden="true"></div>
<section class="event-surface results-page">
  <div class="container">
    <div class="results-header">
      <h3 class="mb-0">Your Results â€“ {{ event.title }}</h3>
      <div id="actionsDropdown" class="actions-dropdown" style="position:relative; margin-left:12px;">
        <button type="button" class="actions-btn" onclick="toggleActionsMenu(event)"
                style="background:#0d6efd;color:#fff;padding:8px 22px;border:none;border-radius:8px;font-weight:800;cursor:pointer;transition:background .2s;box-shadow:0 6px 18px rgba(13,110,253,.25);">
          Actions
        </button>

        <!-- Menu (same element, now controlled via .open class) -->
        <div id="actionsMenu">
          <button type="button" onclick="copyEventLink()"
                  style="display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:transparent;color:#e8eaf0;border-radius:8px;font-weight:700;cursor:pointer;"
                  onmouseover="this.style.background='#151922';"
                  onmouseout="this.style.background='transparent';">
            ðŸ“‹ Copy voting link
          </button>
          <button type="button" onclick="document.getElementById('logoutForm').submit();"
                  style="display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:transparent;color:#e8eaf0;border-radius:8px;font-weight:700;cursor:pointer;"
                  onmouseover="this.style.background='#151922';"
                  onmouseout="this.style.background='transparent';">
            ðŸšª Sign out
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile floating action button -->
    <button type="button" class="fab-actions" aria-label="Actions" onclick="toggleActionsMenu(event)">
      <span aria-hidden="true">Action</span>
      <span class="sr-only">Actions</span>
    </button>
  <form id="logoutForm" method="post" action="{% url 'candidate_logout' event_slug=event.slug %}" style="display:none;">
    {% csrf_token %}
  </form>

    {% if rows %}
      <div class="row">
        {% for row in rows %}
          {% with c=row.candidate %}
          <div class="col-md-6 col-lg-4 mb-20">
            <div class="sigma-card p-20" style="text-align:center">
              <div style="width:110px;height:110px;border-radius:12px;overflow:hidden;background:#121419;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:2rem;font-weight:800;text-transform:uppercase;">
                {% if c.photo %}
                  <img src="{{ c.photo.url }}" alt="{{ c.name }}" style="width:100%;height:100%;object-fit:cover">
                {% else %}
                  {{ c.name|slice:":1" }}
                {% endif %}
              </div>
              <div style="font-weight:800">{{ c.name }}</div>
              <div class="muted" style="font-size:.95rem">{{ c.category.name }}</div>
              <hr>
              <div style="font-size:2rem;font-weight:900;letter-spacing:.5px">{{ row.total_votes }}</div>
              <div class="muted" style="margin-top:-6px">total votes</div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <div class="sigma-card p-30">
        <p class="mb-0 muted">No candidate records found for this event.</p>
      </div>
    {% endif %}
  </div>
<script>
  (function(){
    function calcHeaderHeight(){
      const candidates = [
        document.querySelector('.sigma-header'),
        document.querySelector('.site-header'),
        document.querySelector('header'),
        document.querySelector('nav.navbar'),
        document.querySelector('.navbar'),
        document.querySelector('.main-header')
      ].filter(Boolean);
      const h = candidates.length ? Math.max(...candidates.map(el => el.getBoundingClientRect().height || 0)) : 0;
      return Math.max(80, Math.round(h) + 24);
    }
    function applySpacer(){
      const spacer = document.getElementById('stickySpacer');
      if (!spacer) return;
      spacer.style.height = calcHeaderHeight() + 'px';
    }
    document.addEventListener('DOMContentLoaded', applySpacer);
    window.addEventListener('load', applySpacer);
    window.addEventListener('resize', applySpacer);
    const header = document.querySelector('.sigma-header') || document.querySelector('header') || null;
    if (window.ResizeObserver && header){
      const ro = new ResizeObserver(applySpacer);
      ro.observe(header);
    }
  })();

  function toggleActionsMenu(ev){
    if (ev && ev.stopPropagation) ev.stopPropagation();
    const menu = document.getElementById('actionsMenu');
    if (!menu) return;
    const isOpen = menu.classList.toggle('open');
    console.log('[DEBUG] toggleActionsMenu -> open:', isOpen);

    // keep aria-expanded updated on desktop trigger
    const trigger = document.querySelector('#actionsDropdown button.actions-btn');
    if (trigger) trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
  }

  // Close when clicking outside or pressing ESC
  document.addEventListener('click', function(e){
    const menu = document.getElementById('actionsMenu');
    if (!menu) return;
    const dd = document.getElementById('actionsDropdown');
    const fab = document.querySelector('.fab-actions');
    const clickInside = (dd && dd.contains(e.target)) || (fab && fab.contains(e.target)) || menu.contains(e.target);
    if (!clickInside){
      menu.classList.remove('open');
      const trigger = dd ? dd.querySelector('button.actions-btn') : null;
      if (trigger) trigger.setAttribute('aria-expanded', 'false');
    }
  });
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape'){
      const menu = document.getElementById('actionsMenu');
      if (menu) menu.classList.remove('open');
      const trigger = document.querySelector('#actionsDropdown button.actions-btn');
      if (trigger) trigger.setAttribute('aria-expanded', 'false');
    }
  });

  function copyEventLink() {
    const votingUrl = window.location.origin + "{% url 'event_detail' slug=event.slug %}";
    navigator.clipboard.writeText(votingUrl).then(
      () => alert('Voting link copied to clipboard!'),
      (err) => alert('Failed to copy voting link: ' + err)
    );
  }
</script>
</section>
{% endblock %}